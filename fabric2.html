<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
    <script src="https://kit.fontawesome.com/943416a943.js" crossorigin="anonymous"></script>
    <title>KDraw</title>
    <style>
        .fa-arrow-pointer:hover {
      color: grey;
    }

      .fa-pencil:hover {
      color: grey;
    } 

    .fa-ruler:hover {    
      color: grey;
    }

    .fa-trash:hover {
      color: grey;
    }
    </style>
  </head>
  <body> 
      <video autoplay playsinline webkit-playsinline muted hidden id="videoelement"></video>
      <div class="h-100 d-flex align-items-center justify-content-center">
        <h1>KDraw</h1>
      </div>
      <div class="h-100 d-flex align-items-center justify-content-center"> 
          <canvas id="canvaselement" width="635" height="375" style="position: absolute; z-index: 0; border:2px solid red;"></canvas> 
	        <canvas id="draw" width="635" height="375" style="position: absolute; z-index: 1; border:2px solid #000000;"></canvas>
      </div>
      <div class="h-100 d-flex align-items-center justify-content-center">
        <span style="border: 1px solid silver; border-radius: 0.25em; padding: 0.5em;"><i id="select" class="fa-sharp fa-solid fa-arrow-pointer fa-2xl" title="select"></i></span>
        <span style="border: 1px solid silver; border-radius: 0.25em; padding: 0.5em;"><i id="sketch" class="fa-solid fa-pencil fa-2xl" title="sketch"></i></span>
        <span style="border: 1px solid silver; border-radius: 0.25em; padding: 0.5em;"><i id="measure" class="fa-solid fa-ruler fa-2xl" title="measure"></i></span>
        <span style="border: 1px solid silver; border-radius: 0.25em; padding: 0.5em;"><i id="clear" class="fa-solid fa-trash fa-2xl" title="clear"></i></span>
      </div>
  
    <script src="https://unpkg.com/fabric@5.3.0/dist/fabric.min.js"></script>

    <script>
      var videoelement = document.getElementById("videoelement");
      var streamConstraints = {
        facingMode: 'user',
            audio: false,
            'video': {
                height: 375,
                width: 635
        },
      };

      var canvaselement = document.querySelector('#canvaselement');
      var ctx = canvaselement.getContext('2d', { alpha: false });
      //ctx.canvas.width = window.innerWidth;
      //ctx.canvas.height = window.innerHeight;

      // create a wrapper around native canvas element
      var canvas = new fabric.Canvas('draw');
      canvas.isDrawingMode = false;
      fabric.Object.prototype.selectable = false;

      var canvasInterval = null;
      var fps=60;
      let measuring = false;
      var line = null;
      var line_distance = 0;

      // Get camera stream
      if (videoelement) {
          navigator.mediaDevices
          .getUserMedia(streamConstraints)
          .then(gotStream)
          .catch(function (e) {
              if (confirm("An error with camera occured:(" + e.name + ") Do you want to reload?")) {
                  location.reload();
              }
          });
      }
      //if stream found 
      function gotStream(stream) {
          videoelement.srcObject = stream 
          videoelement.play()
      }

      // Draw camera frame onto canvas
      function drawImage(video) {
          ctx.drawImage(video, 0, 0, canvaselement.width, canvaselement.height);
      }

      // Frame rate
      canvasInterval = window.setInterval(() => {
          drawImage(videoelement);
      }, 1000 / fps);

      // Event listeners
      document.getElementById("select").addEventListener("click", function(){
        measuring = false;
        canvas.isDrawingMode = false;
      })

      document.getElementById("sketch").addEventListener("click", function(){
        measuring = false;
        canvas.isDrawingMode = true;
      })

      document.getElementById("clear").addEventListener("click", function(){
        canvas.clear()
      })

      document.getElementById("measure").addEventListener("click", function(){
        measuring = true;
        canvas.isDrawingMode = false;
      })

      // Measure line
      canvas.on('mouse:down', function(o) {
      if (!measuring) return;
      canvas.isDrawingMode = true;
      var drawingLine = true;
      var pointer = canvas.getPointer(o.e);
      var points = [pointer.x, pointer.y, pointer.x, pointer.y];
      x1 = pointer.x;
      y1 = pointer.y;
      line = new fabric.Line(points, {
          strokeWidth: 5,
          strokeLineCap: "square",
          stroke: 'red',
          strokeUniform: true,
          selectable: true,
          scalable: false,
          originX: 'center',
          originY: 'center'
      });
      canvas.add(line);
      text = new fabric.Textbox(line_distance + 'px', { 
            left: x1, 
            top: y1,
            width: 50,
            selectable: true,
            fontSize: 18,
            fill: "#fff",
          });
      canvas.add(text);
      });

      canvas.on('mouse:move', function(o) {
      if (!measuring) return; 
      if (!canvas.isDrawingMode) return;
      pointer = canvas.getPointer(o.e);
      // Update distance readout
      line_distance = Math.round(Math.sqrt((pointer.x - x1) ** 2 + (pointer.y - y1) ** 2));
      line.set({ x2: pointer.x, y2: pointer.y });
      document.getElementById('distance').innerHTML = (line_distance + 'px');
      text.set('text', line_distance + 'px');
      canvas.renderAll();
      });

      canvas.on('mouse:up', function(o) {
      if (!measuring) return;
        canvas.isDrawingMode = false;
        line.setCoords();
      });

      canvas.on('object:moving', function(o){
        measuring = false;
      });

    </script>
  </body>
</html>