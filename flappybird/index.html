<!DOCTYPE html>
<html>
<head>
    <script src="//cdn.jsdelivr.net/npm/phaser@3.60.0/dist/phaser.min.js"></script>
</head>
<body>
    <script>
    
    let spaceBar;
    let ground_physics;
    let background;
    let background2;
    let pipes;
    let margin;
    let bird;
    let isJumping = false;
    let touch;
    let isClicking = false;
    let flap;
    let ding;
    let started = false;
    let get_ready;
    let title;
    let score;
    let value = 0;

    class GamePlay extends Phaser.Scene {
        constructor() {
            super('game');
        }

        preload () {
            this.load.image('get_ready', 'get_ready.png');
            this.load.image('flappybird', 'flappybird.png');

            this.load.image('ground', 'ground.png');
            this.load.image('background', 'background.png');
            this.load.image('bird1', 'bird1.png');
            this.load.image('bird2', 'bird2.png');
            this.load.image('bird3', 'bird3.png');
            this.load.image('pipe', 'pipe2.png');
            this.load.image('pipe180', 'pipe2 180.png');
            this.load.audio('flap', 'flap.mp3');
            this.load.audio('ding', 'score.wav');
        }

        create() {
            // Boundary collision
            const barrier = this.physics.add.staticGroup();

            // Top barrier
            barrier.create(0, 0, 'background').setOrigin(0, 1).refreshBody();

            // Generate a random integer between min (inclusive) and max (inclusive)
            function getRandomInt(min, max) {
            min = Math.ceil(min);
            max = Math.floor(max);
            return Math.floor(Math.random() * (max - min + 1)) + min;
            }

            spaceBar = this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.SPACE);
            flap = this.sound.add('flap');
            ding = this.sound.add('ding');

            // Create the background sprite
            background = this.add.sprite(0, -200, 'background').setOrigin(0, 0);
            background2 = this.add.sprite(431, -200, 'background').setOrigin(0, 0);

            // Physics for pipes
            margin = 200;
            pipes = this.physics.add.staticGroup();
            for (var i = 0; i < 20; i++) {
                let randomY = getRandomInt(200, 400);
                pipes.create(400 + margin, randomY, 'pipe').setOrigin(0, 0).refreshBody();
                pipes.create(400 + margin, (randomY - getRandomInt(100, 200)), 'pipe180').setOrigin(0, 1).refreshBody();
                margin += 400;
            }
            

            // Physics for ground
            ground_physics = this.physics.add.staticGroup();
            ground_physics.create(0, 500, 'ground').setOrigin(0, 0).refreshBody();
            ground_physics.create(468, 500, 'ground').setOrigin(0, 0).refreshBody();
            
            // Debugging
            //this.physics.world.createDebugGraphic();
            
            // Create the bird sprite
            bird = this.physics.add.sprite(170, 250, 'bird1'); // Adjust the position as needed

            this.anims.create({
                key: 'birdAnimation',
                frames: [
                    { key: 'bird1' },
                    { key: 'bird2' },
                    { key: 'bird3'},
                    { key: 'bird2'}
                ],
                frameRate: 10, // Frames per second (e.g., 24)
                repeat: -1 // -1 means the animation repeats indefinitely
            });

            // Play the "birdAnimation" when a specific event occurs
            bird.play('birdAnimation');

            const Callback = () => {
                started = false;
                isJumping = false;
                value = 0;
                this.registry.destroy(); // destroy registry
                this.events.off(); // disable all active events
                this.scene.restart(); // restart current scene
            };

            // Check for collisions
            this.physics.add.collider(bird, pipes, Callback);
            this.physics.add.collider(bird, ground_physics, Callback);
            this.physics.add.collider(bird, barrier);
            
            // Input for jumping
            const jump = () => {
                isJumping = true
                bird.setVelocityY(-350); //-350
                flap.play();
                started = true;
            };

            this.input.keyboard.on('keyup-SPACE', event => jump());
            this.input.on('pointerup', event => jump());

            get_ready = this.add.image(200, 400, 'get_ready');
            title = this.add.image(200, 100, 'flappybird');
            score = this.add.text(200, 50, '', { font: '55px Arial', fill: '#ffffff' }).setOrigin(0.5, 0.5);
        }

        update() {
            // Scroll the ground horizontally
            let scrollSpeed = 3; // Adjust the scrolling speed as needed
            ground_physics.children.iterate(item => {
                item.x -= scrollSpeed;
                // Reset if it has gone off screen
                if (item.x + 468 <= 0) {
                item.x = 468;
                }
            })

            // Scroll the background
            background.x -= 1;
            background2.x -= 1;

            if (background.x + 431 <= 0) {
                background.x = 429;
            }
            if (background2.x + 431 <= 0) {
                background2.x = 429; 
            }

            // Scroll the pipes horizontally
            if (started) {
                pipes.children.iterate(item => {
                    item.x -= scrollSpeed;
                    item.body.x -= scrollSpeed;

                    // Check if bird has passed pipe and update score
                    if (bird.x == item.x + 100 || bird.x == item.x + 101 || bird.x == item.x + 102) {
                        ding.play();
                        value += .5;
                    }
                })

                // Remove title info and update score
                get_ready.setVisible(false);
                title.setVisible(false);
                score.setText(`${value}`);
            }

            if (isJumping) {
                // Apply gravity while the bird is in the air
                bird.setGravityY(750); //750
            }

            // If bird is going up or down tilt angle
            bird.angle = Math.min(90, bird.body.velocity.y * 0.15);
        }
    }

    var config = {
        type: Phaser.AUTO,
        width: 400,
        height: 600,
        transparent: true,
        physics: {
            default: 'arcade',
            arcade: {
                gravity: { y: 0 }
            }
        },
        scene: [ 
        GamePlay
        ]
    };

    var game = new Phaser.Game(config);

    </script>

</body>
</html>